<html>
<head>
  <title><%= title %> - Application powered by IoT for Electronics</title>

  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <link rel="stylesheet" href="/bootstrap/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="/bootstrap/css/bootstrap-theme.min.css"/>
  <link rel="stylesheet" href="/styles/style.css" />

  <script src="/socket.io/socket.io.js"></script>
  <script src="/javascripts/iotAppMonitorClient.js"></script>
  <script src="/jquery/jquery.min.js"></script>
  <script src="/bootstrap/js/bootstrap.min.js"></script>
</head>
<body>
  <div class="leftHalf">
    <img class="newappIcon" src="/images/newapp-icon.png">
    <h1>Welcome to the <span class="blue">IoT for Electronics</span></h1>
    <br>
    <p class="description">Powered by IBM analytics capabilities, Internet of Things for Electronics generates data-driven insight that transforms businesses and customers experiences across the entire value chain. With this transformation, organizations can capitalize on the increasing demand for intelligent connected devices and experiences brought about by the Internet of Things.</p>
    <br><br>
    <img src="/qr/<%= deviceId %>" style="display: block; margin: 0 auto; vertical-align: middle;">
  </div>
  <div class="rightHalf">

    <header>
      <h1>Device ID: <span id="deviceId">Loading</span></h1>
      <br><br>
      <section>
        <div class="row">
          <div class="col-md-4 col-md-offset-2">
            <img src="/images/washing-machine.png"><br><br>
          </div>
        <div class="col-md-6" style="text-align: left">
          <table cellpadding="0">
            <tr>
              <td><h3>Status:</h3></td>
              <td><h3 id="deviceStatus">Loading</h3></td>
            </tr>
            <tr>
              <td><h3>Failure Type:</h3></td>
              <td><h3 id="deviceFailureType">Loading</h3></td>
            </tr>
            <tr>
              <td><h3>Door Open?</h3></td>
              <td><h3 id="deviceDoorOpen" style="text-transform: capitalize;">Loading</h3></td>
            </tr>
            <tr>
              <td><h3>Program:</h3></td>
              <td><h3 id="deviceProgram">Loading</h3></td>
            </tr>
            <tr>
              <td><h3>Current Cycle:</h3></td>
              <td><h3 id="deviceCurCycle">Loading</h3></td>
            </tr>
          </table>
        </div>
      </div>
    </section>
    </header>
    <footer>
      <div>
        <section>
          <p>Select program:</p>
          <button class="btn-primary program">Stains</button>
          <button class="btn-primary program">Cottons</button>
          <button class="btn-primary program">Synthetics</button>
        </section>
        <br>
        <section>
          <p>Send command:</p>
          <button class="btn-primary command">Start Washing</button>
          <button class="btn-primary command">Stop Washing</button>
          <button class="btn-primary command">Open Door</button>
          <button class="btn-primary command">Close Door</button>
        </section>
        <br>
        <section>
          <p>Send failure event:</p>
          <button class="btn-danger failure">Water Leak</button>
          <button class="btn-danger failure">High Vibrations</button>
          <button class="btn-danger failure">Board Malfunction</button>
        </section>
        <br>
        <section>
          <button class="btn-danger command">Reset Simulation Client</button>
        </section>
      </div>
    </footer>
  </div>

  <script>
      $(document).ready(function() {
          $("#deviceId").text("<%= deviceId %>");
          $("#deviceStatus").text("<%= deviceStatus %>");
          $("#deviceDoorOpen").text("<%= deviceDoorOpen %>");
          $("#deviceProgram").text("<%= deviceProgram %>");
          $("#deviceCurCycle").text("<%= deviceCurCycle %>");
          $("#deviceFailureType").text("<%= deviceFailureType %>").change();

          checkFailureType();

          $("#deviceFailureType").change(function() {
              checkFailureType();
          });

          $(document).on('click', '.program', function() {
              var program = $(this).text();
              $.ajax({
                  url: '/washingMachine/<%= deviceId %>/setAttribute/program',
                  type: 'PUT',
                  data: {
                      value: program
                  },
                  success: function() {
                      $("#deviceProgram").text(program);
                  }
              });
          });

          $(document).on('click', '.command', function() {
              var command = $(this).text();
              var program = $("#deviceProgram").text();
              var url = null;
              switch (command) {
                  case 'Start Washing':
                      $.ajax({
                          url: '/washingMachine/<%= deviceId %>/startWashing',
                          type: 'PUT',
                          success: function() {
                              updateDeviceStatus();
                          }
                      });
                      break;
                  case 'Stop Washing':
                      $.ajax({
                          url: '/washingMachine/<%= deviceId %>/stopWashing',
                          type: 'PUT',
                          success: function() {
                              updateDeviceStatus();
                          }
                      });
                      break;
                  case 'Open Door':
                      $.ajax({
                          url: '/washingMachine/<%= deviceId %>/setAttribute/doorOpen',
                          type: 'PUT',
                          data: {
                              value: "true"
                          },
                          success: function() {
                              updateDeviceStatus();
                          }
                      });
                      break;
                  case 'Close Door':
                      $.ajax({
                          url: '/washingMachine/<%= deviceId %>/setAttribute/doorOpen',
                          type: 'PUT',
                          data: {
                              value: "false"
                          },
                          success: function() {
                              updateDeviceStatus();
                          }
                      });
                      break;
                  case 'Reset Simulation Client':
                      $.ajax({
                          url: '/washingMachine/reset',
                          type: 'PUT'
                      });
                      break;
              }
          });

          $(document).on('click', '.failure', function() {
              var failureType = $(this).text();
              $.ajax({
                  url: '/washingMachine/<%= deviceId %>/setAttributes',
                  type: 'PUT',
                  data: {
                      status: "Failure",
                      failureType: failureType
                  },
                  success: function() {
                      $("#deviceStatus").text("Failure");
                      $("#deviceFailureType").text(failureType).change();
                  }
              });
          });

      });

      var checkFailureType = function() {
          var failureType = $("#deviceFailureType").text();
          if (failureType == "" || failureType == "None") {
              $("#deviceStatus, #deviceFailureType").css('color', 'white');
              $("#deviceFailureType").text("None");
          } else {
              $("#deviceStatus").css('color', '#FF7D7D');
              $("#deviceFailureType").css('color', '#FF7D7D');
          }
      }

      var updateDeviceStatus = function() {
          $.ajax({
              url: '/washingMachine/<%= deviceId %>/getStatus',
              type: 'GET',
              success: function(data) {
                  $("#deviceStatus").text(data.attributes.status);
                  $("#deviceDoorOpen").text(data.attributes.doorOpen);
                  $("#deviceProgram").text(data.attributes.program);
                  $("#deviceCurCycle").text(data.attributes.currentCycle);
                  $("#deviceFailureType").text(data.attributes.failureType).change();
              }
          });
      }

      iotAppMonitorClient.mqtt = function(id, message) {
          if (id === "<%= deviceId %>") {
              var device = JSON.parse(message).d;
              $("#deviceStatus").text(device.status);
              $("#deviceDoorOpen").text(device.doorOpen);
              $("#deviceProgram").text(device.program);
              $("#deviceCurCycle").text(device.currentCycle);
              $("#deviceFailureType").text(device.failureType).change();
          }
      };
  </script>

</body>
</html>