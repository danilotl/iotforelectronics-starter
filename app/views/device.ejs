<html>
  <head>
    <title>Single Device Simulator - Application powered by IoT for Electronics</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link rel="stylesheet" href="/bootstrap/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="/bootstrap/css/bootstrap-theme.min.css"/>
    <link rel="stylesheet" href="/styles/style.css"/>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/javascripts/iotAppMonitorClient.js"></script>
    <script src="/jquery/jquery.min.js"></script>
    <script src="/bootstrap/js/bootstrap.min.js"></script>
  </head>
  <body>
    <h4 class="bluemix-bar">Simulated washer experience</h4>
    <div class="main-section">
      <div class="container">
        <h2 >Command and control your simulated washer</h2>
        <section class="col-xs-12 col-md-10 content washer-content">
          <div class="col-xs-12 col-sm-4 problem-machine">
            <h3>Select a problem</h3>
            <p>Watch your washer 's status change. When you try the consumer app, a status change message will automatically be sent to your iOS phone</p>
            <div class="problem-machine-icons">
              <p><img src="/images/board-failure-icon.png"><button class="board-failure">Board failure</button></p>
              <p><img src="/images/strong-vibration-icon.png"/> <button class="strong-vibration">Strong vibration</button></p>
              <p><img src="/images/water-leak-icon.png"/> <button class="water-leak">Water leak</button></p>
            </div>
            <div class="problem-machine-buttons">
              <button>Reset machine</button>
              <button>Delete washer</button>
            </div>
          </div>
          <div class="col-xs-12 col-sm-8 machine-info">
            <div class="washer-details">
              <div class="washer-content">
                <img src="/images/washer.png" class="washer-machine"/>
              </div>
              <div class="washer-content">
                <div class="washer-text">
                  <h3 class="washer-title"><span><%= deviceId %></span></h3>
                  <ul class="text-list"><li>Device ID </li><li><%= deviceId %></li></ul>
                  <ul class="text-list"><li>Serial Number </li><li><%= serialNumber %></li></ul>
                  <ul class="text-list"><li>Make, Model </li><li><%= make %> <%= model %></li></ul>
                  <h3 class="washer-title">Washer Status</h3>
                  <ul class="text-list"><li>Overall status  </li><li><strong><%= deviceStatus %></strong></li></ul>
                  <ul class="text-list"><li>Vibration </li><li><strong><%= vibration %></strong></li></ul>
                  <ul class="text-list"><li>Water pressure </li><li><strong><%= waterPressure %></strong></li></ul>
                </div>
              </div>
            </div>
            <div class="washer-app-info">
              <div>
                <img src="/qr/<%= deviceId %>"/>
              </div>
              <div>
                <p>When you try the consumer app, you can scan the QR code to see this washer's status and other events on your phone.</p>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>
    <script type="text/javascript">
      $(document).ready(function(){

        // Reset machine
        $('.problem-machine-buttons button').eq(0).on('click', function(e){
          e.preventDefault();
          $.ajax({
            url: '/washingMachine/reset',
            type: 'PUT'
          });
        });

        // Delete device
        $('.problem-machine-buttons button').eq(1).on('click', function(e){
          e.preventDefault();
          $.ajax({
            url: '/washingMachine/<%= deviceId %>',
            type: 'DELETE',
            success: function(){
              alert('Device was deleted.');
              window.close();
            }
          });
        });

        $('.problem-machine-icons p').on('click', function(e){
          e.preventDefault();
          var failureType = $(this).find('button').text();
          var obj = {};
          var index = 0;
          var text = '';
          obj['status'] = 'Failure';
          obj['failureType'] = failureType;
          switch(failureType){
            case 'Strong vibration':
            index = 1;
            text = "150 mps";
            obj['vibration'] = text;
            break;
            case 'Water leak':
            index = 2;
            text = "70 psi";
            obj['waterPressure'] = text;
            break;
          }
          var data = JSON.parse(JSON.stringify(obj));
          $.ajax({
            url: '/washingMachine/<%= deviceId %>/setAttributes',
            type: 'PUT',
            data: data,
            success: function() {
              $('.washer-content .washer-text p strong').eq(0).text('Failure');
              if(index > 0){
                $('.washer-content .washer-text p strong').eq(index).text(text);
              }
            }
          });
        });
      });

      iotAppMonitorClient.mqtt = function(id, message) {
        if (id === "<%= deviceId %>") {
          var device = JSON.parse(message).d;
          $('.washer-content .washer-text ul li strong').eq(0).text(device.status);
          $('.washer-content .washer-text ul li strong').eq(1).text(device.vibration);
          $('.washer-content .washer-text ul li strong').eq(2).text(device.waterPressure);
        }
      };
    </script>
  </body>
</html>